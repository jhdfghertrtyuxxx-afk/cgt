<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Cambridge Gambling Task (CGT) 简化版</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
    }
    #container {
      background: #ffffff;
      margin-top: 40px;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 800px;
      width: 100%;
    }
    h1 {
      text-align: center;
      margin-top: 0;
    }
    #statusBar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
    }
    #message {
      margin: 10px 0;
      min-height: 40px;
    }
    #boxes {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin: 20px 0;
    }
    .box {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .redBox { background: #e74c3c; }
    .blueBox { background: #3498db; }
    #controls {
      text-align: center;
      margin-top: 10px;
    }
    button {
      padding: 8px 16px;
      margin: 4px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .primary {
      background: #3498db;
      color: #fff;
    }
    .danger {
      background: #e74c3c;
      color: #fff;
    }
    .secondary {
      background: #95a5a6;
      color: #fff;
    }
    #betDisplay {
      font-size: 24px;
      margin: 10px 0;
    }
    #downloadBtn {
      margin-top: 20px;
    }
    #instructions {
      font-size: 14px;
      line-height: 1.6;
    }
    #startBtn {
      display: block;
      margin: 20px auto 0;
    }
  </style>
</head>
<body>
<div id="container">
  <h1>Cambridge Gambling Task（CGT）简化版</h1>

  <div id="statusBar">
    <div>当前 Block：<span id="blockInfo">-</span></div>
    <div>当前 Trial：<span id="trialInfo">-</span>/40</div>
    <div>当前点数：<span id="pointsInfo">-</span></div>
  </div>

  <div id="instructions">
    <p><b>任务说明：</b></p>
    <ol>
      <li>每一轮屏幕上方会出现 10 个方块，其中一部分是红色，一部分是蓝色。</li>
      <li>一个黄色小球随机藏在其中一个方块下面（你看不见）。</li>
      <li>你需要判断：你觉得小球<b>更可能在红色下面，还是蓝色下面</b>？点击“选红色”或“选蓝色”。</li>
      <li>然后，你需要从当前点数中<b>拿出一部分来下注</b>。下注比例会在中间自动轮换（例如 5%、25%、50%、75%、95%），当出现你想要的下注比例时，点击“确认下注”。</li>
      <li>如果你猜对颜色，就<b>赢得</b>本轮下注的点数；如果猜错，就<b>失去</b>本轮下注的点数。</li>
      <li>你的目标是在任务结束时，让自己的<b>总点数尽可能多</b>。</li>
    </ol>
    <p>共 2 个 Block，每个 20 轮（总 40 轮）。Block 1 下注比例按 5→25→50→75→95 升序轮换，Block 2 按 95→75→50→25→5 降序轮换。</p>
  </div>

  <button id="startBtn" class="primary">开始任务</button>

  <div id="message"></div>
  <div id="boxes"></div>
  <div id="betDisplay"></div>

  <div id="controls">
    <div id="colorButtons" style="display:none;">
      <button id="chooseRed" class="danger">选红色</button>
      <button id="chooseBlue" class="primary">选蓝色</button>
    </div>
    <div id="betButtons" style="display:none;">
      <button id="confirmBet" class="primary">在当前比例下注</button>
    </div>
  </div>

  <button id="downloadBtn" style="display:none;" class="secondary">下载 CSV 数据</button>
</div>

<script>
  // ================== 实验配置 ==================
  const START_POINTS = 100;
  const TOTAL_BLOCKS = 2;
  const TRIALS_PER_BLOCK = 20; // 5 种比例 × 4 次
  const TOTAL_TRIALS = TOTAL_BLOCKS * TRIALS_PER_BLOCK;

  // 红蓝比例列表（红:蓝）
  const ratioList = [
    {red:9, blue:1},
    {red:8, blue:2},
    {red:7, blue:3},
    {red:6, blue:4},
    {red:5, blue:5}
  ];

  // 下注比例（百分比）
  const betOptionsAscending = [5, 25, 50, 75, 95];
  const betOptionsDescending = [95, 75, 50, 25, 5];

  // ================== 状态变量 ==================
  let trials = [];        // 预生成的 trial 列表
  let currentTrialIndex = -1;
  let currentPoints = START_POINTS;
  let currentTrial = null;
  let phase = "instructions"; // instructions / color / bet / outcome / finished
  let betTimer = null;
  let betIndex = 0;
  let dataRows = [];

  // ================== DOM 引用 ==================
  const blockInfoSpan = document.getElementById('blockInfo');
  const trialInfoSpan = document.getElementById('trialInfo');
  const pointsInfoSpan = document.getElementById('pointsInfo');

  const messageDiv = document.getElementById('message');
  const boxesDiv = document.getElementById('boxes');
  const betDisplayDiv = document.getElementById('betDisplay');

  const startBtn = document.getElementById('startBtn');
  const colorButtonsDiv = document.getElementById('colorButtons');
  const chooseRedBtn = document.getElementById('chooseRed');
  const chooseBlueBtn = document.getElementById('chooseBlue');

  const betButtonsDiv = document.getElementById('betButtons');
  const confirmBetBtn = document.getElementById('confirmBet');

  const downloadBtn = document.getElementById('downloadBtn');

  // ================== 工具函数 ==================
  function shuffle(array) {
    const arr = array.slice();
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function now() {
    return performance.now();
  }

  // 生成 trial 列表：2 个 block，每个 block 20 trial（5 个比例 × 4 次）
  function generateTrials() {
    let trialsArr = [];
    let trialCounter = 1;
    for (let block = 1; block <= TOTAL_BLOCKS; block++) {
      // 每个 block 内 5 个比例各重复 4 次
      let blockRatios = [];
      ratioList.forEach(r => {
        for (let i = 0; i < 4; i++) {
          blockRatios.push({red: r.red, blue: r.blue});
        }
      });
      blockRatios = shuffle(blockRatios);

      const betOrder = (block === 1) ? "ascending" : "descending";

      blockRatios.forEach((rb, indexInBlock) => {
        const trial = {
          globalTrial: trialCounter,
          block: block,
          trialInBlock: indexInBlock + 1,
          ratioRed: rb.red,
          ratioBlue: rb.blue,
          betOrder: betOrder,

          // 运行时填充：
          majorityColor: null,
          tokenColor: null,      // 实际 token 颜色
          chosenColor: null,
          colorRT: null,
          betPercent: null,
          betRT: null,
          correct: null,
          wonLoss: null,
          pointsAfter: null
        };
        // 多数颜色：red or blue（可能 5:5 时平手，记为 "none"）
        if (rb.red > rb.blue) trial.majorityColor = "red";
        else if (rb.blue > rb.red) trial.majorityColor = "blue";
        else trial.majorityColor = "none";

        trialsArr.push(trial);
        trialCounter++;
      });
    }
    return trialsArr;
  }

  // 显示当前状态栏
  function updateStatusBar() {
    if (!currentTrial) {
      blockInfoSpan.textContent = "-";
      trialInfoSpan.textContent = "-";
      pointsInfoSpan.textContent = "-";
      return;
    }
    blockInfoSpan.textContent = `${currentTrial.block} / ${TOTAL_BLOCKS}`;
    trialInfoSpan.textContent = `${currentTrial.globalTrial} / ${TOTAL_TRIALS}`;
    pointsInfoSpan.textContent = currentPoints;
  }

  // 显示红蓝方块
  function renderBoxes() {
    boxesDiv.innerHTML = "";
    if (!currentTrial) return;
    const total = 10;
    const redCount = currentTrial.ratioRed;
    const blueCount = currentTrial.ratioBlue;

    // 先创建红蓝数组再随机打散位置（实际上位置无关紧要，只是视觉展示）
    let colors = [];
    for (let i = 0; i < redCount; i++) colors.push("red");
    for (let i = 0; i < blueCount; i++) colors.push("blue");
    colors = shuffle(colors);

    colors.forEach(color => {
      const div = document.createElement('div');
      div.classList.add('box');
      if (color === "red") div.classList.add('redBox');
      else div.classList.add('blueBox');
      boxesDiv.appendChild(div);
    });
  }

  // 开始下一 trial
  function nextTrial() {
    // 清理上一 trial 的下注计时器
    clearBetTimer();

    currentTrialIndex++;
    if (currentTrialIndex >= trials.length) {
      endTask();
      return;
    }

    currentTrial = trials[currentTrialIndex];
    phase = "color";

    // 为当前 trial 随机选择 token 颜色（按比例）
    const arr = [];
    for (let i = 0; i < currentTrial.ratioRed; i++) arr.push("red");
    for (let i = 0; i < currentTrial.ratioBlue; i++) arr.push("blue");
    currentTrial.tokenColor = arr[Math.floor(Math.random() * arr.length)];

    updateStatusBar();
    renderBoxes();

    // UI 切换
    messageDiv.textContent = "第 " + currentTrial.globalTrial + " 轮：请选择你认为黄色小球更可能在红色还是蓝色下面。";
    betDisplayDiv.textContent = "";
    colorButtonsDiv.style.display = "block";
    betButtonsDiv.style.display = "none";
  }

  // color 选择
  function handleColorChoice(color) {
    if (phase !== "color") return;
    phase = "bet";

    currentTrial.chosenColor = color;
    currentTrial.colorRT = now() - currentTrial.colorStartTime;

    messageDiv.textContent = "现在请选择下注比例。当你看到想要的比例时，点击下面按钮确认下注。";
    colorButtonsDiv.style.display = "none";
    betButtonsDiv.style.display = "block";

    startBetCycle();
  }

  // 启动下注比例轮换
  function startBetCycle() {
    clearBetTimer();

    const options = (currentTrial.betOrder === "ascending") ? betOptionsAscending : betOptionsDescending;
    betIndex = 0;
    const startTime = now();
    currentTrial.betStartTime = startTime;

    betDisplayDiv.textContent = `当前下注比例：${options[betIndex]}%`;

    betTimer = setInterval(() => {
      betIndex = (betIndex + 1) % options.length;
      betDisplayDiv.textContent = `当前下注比例：${options[betIndex]}%`;
    }, 1000); // 每秒切一次
  }

  function clearBetTimer() {
    if (betTimer) {
      clearInterval(betTimer);
      betTimer = null;
    }
  }

  // 确认下注
  function handleConfirmBet() {
    if (phase !== "bet") return;
    phase = "outcome";

    clearBetTimer();
    const options = (currentTrial.betOrder === "ascending") ? betOptionsAscending : betOptionsDescending;
    const chosenBetPercent = options[betIndex];
    currentTrial.betPercent = chosenBetPercent;
    currentTrial.betRT = now() - currentTrial.betStartTime;

    // 计算赢/输
    const betAmount = Math.round(currentPoints * (chosenBetPercent / 100));
    let outcomeText = "";

    if (currentTrial.chosenColor === currentTrial.tokenColor) {
      // 赢
      currentTrial.correct = 1;
      currentTrial.wonLoss = betAmount;
      currentPoints += betAmount;
      outcomeText = `你猜对了！你赢得 ${betAmount} 点。`;
    } else {
      // 输
      currentTrial.correct = 0;
      currentTrial.wonLoss = -betAmount;
      currentPoints -= betAmount;
      outcomeText = `你猜错了。你失去 ${betAmount} 点。`;
    }

    currentTrial.pointsAfter = currentPoints;
    updateStatusBar();

    messageDiv.textContent = outcomeText + " 小球实际在：" + (currentTrial.tokenColor === "red" ? "红色方块" : "蓝色方块") + " 下方。";
    betButtonsDiv.style.display = "none";
    betDisplayDiv.textContent += "\n（本轮结束）";

    // 保存数据
    saveCurrentTrialData();

    // 短暂停顿再进入下一轮
    setTimeout(() => {
      nextTrial();
    }, 1000);
  }

  function saveCurrentTrialData() {
    const t = currentTrial;
    dataRows.push({
      globalTrial: t.globalTrial,
      block: t.block,
      trialInBlock: t.trialInBlock,
      ratioRed: t.ratioRed,
      ratioBlue: t.ratioBlue,
      majorityColor: t.majorityColor,
      betOrder: t.betOrder,
      tokenColor: t.tokenColor,
      chosenColor: t.chosenColor,
      colorRT: t.colorRT != null ? t.colorRT.toFixed(0) : "",
      betPercent: t.betPercent,
      betRT: t.betRT != null ? t.betRT.toFixed(0) : "",
      correct: t.correct,
      wonLoss: t.wonLoss,
      pointsAfter: t.pointsAfter
    });
  }

  // 结束任务
  function endTask() {
    phase = "finished";
    colorButtonsDiv.style.display = "none";
    betButtonsDiv.style.display = "none";
    boxesDiv.innerHTML = "";
    betDisplayDiv.textContent = "";

    messageDiv.textContent = `任务结束！你的最终点数为 ${currentPoints}。你可以点击下方按钮下载本次数据（CSV）。`;
    downloadBtn.style.display = "inline-block";
  }

  // 生成 CSV
  function exportCSV() {
    if (dataRows.length === 0) return;

    const header = [
      "globalTrial",
      "block",
      "trialInBlock",
      "ratioRed",
      "ratioBlue",
      "majorityColor",
      "betOrder",
      "tokenColor",
      "chosenColor",
      "colorRT_ms",
      "betPercent",
      "betRT_ms",
      "correct",
      "wonLoss",
      "pointsAfter"
    ];
    const lines = [header.join(",")];

    dataRows.forEach(row => {
      const line = header.map(h => row[h]).join(",");
      lines.push(line);
    });

    const csvContent = "\uFEFF" + lines.join("\n");
    const blob = new Blob([csvContent], {type: "text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "CGT_data.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ================== 事件绑定 ==================
  startBtn.addEventListener('click', () => {
    startBtn.style.display = "none";
    messageDiv.textContent = "任务即将开始，请专心完成。";
    trials = generateTrials();
    currentPoints = START_POINTS;
    currentTrialIndex = -1;
    dataRows = [];

    // 小延迟后开始第一轮
    setTimeout(() => {
      nextTrial();
    }, 1000);
  });

  chooseRedBtn.addEventListener('click', () => {
    currentTrial.colorStartTime = currentTrial.colorStartTime || now();
    handleColorChoice("red");
  });

  chooseBlueBtn.addEventListener('click', () => {
    currentTrial.colorStartTime = currentTrial.colorStartTime || now();
    handleColorChoice("blue");
  });

  confirmBetBtn.addEventListener('click', () => {
    handleConfirmBet();
  });

  downloadBtn.addEventListener('click', exportCSV);

  // 初始状态栏
  updateStatusBar();
</script>
</body>
</html>